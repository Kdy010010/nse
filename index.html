<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>블록 코딩 확장</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    #stage {
      width: 500px;
      height: 400px;
      border: 2px solid black;
      position: relative;
      background-color: lightblue;
      margin-top: 20px;
    }

    .sprite {
      width: 50px;
      height: 50px;
      position: absolute;
      background-color: red;
    }

    .green-flag {
      width: 50px;
      height: 50px;
      background-color: green;
      display: inline-block;
      cursor: pointer;
      margin: 10px 0;
    }
  </style>
</head>
<body>

  <h1>드래그앤드롭 블록 코딩 확장</h1>

  <!-- Blockly 작업 공간 -->
  <div id="blocklyDiv" style="height: 400px; width: 600px;"></div>

  <!-- 스프라이트가 있는 스테이지 -->
  <div id="stage">
    <div id="sprite1" class="sprite"></div>
  </div>

  <!-- 그린 플래그 (코드 실행 버튼) -->
  <div class="green-flag" onclick="runCode()">그린 플래그</div>

  <!-- 실행 버튼 -->
  <button onclick="runCode()">코드 실행</button>

  <!-- 내보내기 및 불러오기 버튼 -->
  <button onclick="exportBlocks()">블록 내보내기</button>
  <button onclick="importBlocks()">블록 불러오기</button>

  <script>
    // Blockly 기본 설정 (툴박스 정의)
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: `
        <xml xmlns="https://developers.google.com/blockly/xml">
          <block type="move_right"></block>
          <block type="move_left"></block>
          <block type="move_up"></block>
          <block type="move_down"></block>
          <block type="change_shape"></block>
          <block type="repeat"></block>
          <block type="if_then"></block>
        </xml>
      `
    });

    // 블록 정의: 오른쪽으로 이동
    Blockly.Blocks['move_right'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("X축 오른쪽으로 이동");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
      }
    };

    // 블록 정의: 왼쪽으로 이동
    Blockly.Blocks['move_left'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("X축 왼쪽으로 이동");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
      }
    };

    // 블록 정의: 위로 이동
    Blockly.Blocks['move_up'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Y축 위로 이동");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(180);
      }
    };

    // 블록 정의: 아래로 이동
    Blockly.Blocks['move_down'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("Y축 아래로 이동");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(180);
      }
    };

    // 블록 정의: 모양 변경
    Blockly.Blocks['change_shape'] = {
      init: function() {
        this.appendDummyInput()
            .appendField("모양 변경");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(160);
      }
    };

    // JavaScript 코드 생성
    Blockly.JavaScript['move_right'] = function(block) {
      return 'moveSpriteX(10);\n';
    };

    Blockly.JavaScript['move_left'] = function(block) {
      return 'moveSpriteX(-10);\n';
    };

    Blockly.JavaScript['move_up'] = function(block) {
      return 'moveSpriteY(-10);\n';
    };

    Blockly.JavaScript['move_down'] = function(block) {
      return 'moveSpriteY(10);\n';
    };

    Blockly.JavaScript['change_shape'] = function(block) {
      return 'changeSpriteShape();\n';
    };

    // 스프라이트 선택 및 제어
    const sprite = document.getElementById('sprite1');
    let isCircle = false; // 모양 상태를 저장

    function moveSpriteX(distance) {
      let currentLeft = parseInt(window.getComputedStyle(sprite).left, 10) || 0;
      sprite.style.left = (currentLeft + distance) + 'px';
    }

    function moveSpriteY(distance) {
      let currentTop = parseInt(window.getComputedStyle(sprite).top, 10) || 0;
      sprite.style.top = (currentTop + distance) + 'px';
    }

    function changeSpriteShape() {
      if (isCircle) {
        sprite.style.borderRadius = '0%'; // 사각형
        sprite.style.backgroundColor = 'red';
      } else {
        sprite.style.borderRadius = '50%'; // 원형
        sprite.style.backgroundColor = 'blue';
      }
      isCircle = !isCircle; // 모양 토글
    }

    // Blockly로 생성된 코드를 실행하는 함수
    function runCode() {
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      eval(code); // Blockly가 생성한 코드를 실행
    }

    // 블록 내보내기 기능 (저장)
    function exportBlocks() {
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      localStorage.setItem('blocklyXml', xml_text); // 로컬스토리지에 저장
      alert("블록이 저장되었습니다!");
    }

    // 블록 불러오기 기능 (로드)
    function importBlocks() {
      var xml_text = localStorage.getItem('blocklyXml');
      if (xml_text) {
        var xml = Blockly.Xml.textToDom(xml_text);
        Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
        alert("블록이 불러와졌습니다!");
      } else {
        alert("저장된 블록이 없습니다.");
      }
    }
  </script>

</body>
</html>
